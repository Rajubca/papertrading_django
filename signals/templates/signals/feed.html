{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live Trade Signals</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}"> <!-- optional -->
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .layout { display: grid; grid-template-columns: 1fr; gap: 16px; }
    .toolbar { display: flex; align-items: center; gap: 12px; }
    .badge { padding: 2px 8px; border-radius: 999px; background:#eee; font-size: 12px; }
    .stack { display: grid; gap: 10px; }
    .card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; box-shadow: 0 2px 6px rgba(0,0,0,.04); }
    .card small { color: #6b7280; }
    #toasts { position: fixed; right: 16px; top: 16px; z-index: 9999; display: grid; gap: 8px; }
    .toast { background:#111; color:#fff; padding:10px 12px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,.25); max-width: 360px; }
    .section { margin-top: 8px; }
  </style>
</head>
<body>
  <div class="layout">
    <div class="toolbar">
      <h2 style="margin:0">Live Trade Signals</h2>
      {% if symbol %}
        <span class="badge">Symbol: {{ symbol|upper }}</span>
      {% else %}
        <span class="badge">All symbols</span>
      {% endif %}
      <span class="badge" id="status">Connecting…</span>
    </div>

    {% comment %}
      For "all symbols", we’ll group into stacks per symbol.
      For a specific symbol (/app/signals/<symbol>/), we’ll show one stack.
    {% endcomment %}

    <div id="stacks"></div>
  </div>

  <div id="toasts"></div>

 <script>
(function () {
  const symbol = "{{ symbol|default_if_none:'' }}".trim(); // '' => all
  const symbolUpper = symbol ? symbol.toUpperCase() : "";
  const stacksEl = document.getElementById("stacks");
  const toastsEl = document.getElementById("toasts");
  const statusEl = document.getElementById("status");
  const seen = new Set();

  function getStack(symbolName) {
    const s = (symbolName || "UNKNOWN").toUpperCase();
    const id = "stack-" + s.replace(/[^A-Za-z0-9_.-]/g, "-");
    let section = document.getElementById(id);
    if (!section) {
      section = document.createElement("section");
      section.className = "section";
      section.id = id;
      section.innerHTML = `<h3>${s}</h3><div class="stack"></div>`;
      stacksEl.appendChild(section);
    }
    return section.querySelector(".stack");
  }

  function renderCard(sig) {
    if (!sig || !sig.id) return;
    // Filter if page is for a specific symbol
    if (symbolUpper && String(sig.symbol||"").toUpperCase() !== symbolUpper) return;
    if (seen.has(sig.id)) return; seen.add(sig.id);

    const stack = getStack(sig.symbol || "UNKNOWN");
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div>${sig.message}</div>
      <small>${new Date(sig.created_at || Date.now()).toLocaleString()}</small>
    `;
    stack.prepend(card);
  }

  function toast(text) {
    const box = document.createElement("div");
    box.className = "toast";
    box.textContent = text;
    toastsEl.prepend(box);
    setTimeout(()=>box.remove(), 5000);
  }

  // 1) Initial load via the new endpoint
  async function loadInitial() {
    const qs = symbolUpper ? `?symbol=${encodeURIComponent(symbolUpper)}&limit=100` : `?limit=100`;
    const url = `/api/signals/feed${qs}`;
    try {
      const res = await fetch(url, { credentials: "include" });
      const items = await res.json();
      items.forEach(renderCard);
    } catch (e) {
      console.error("Initial load failed:", e);
    }
  }

  // 2) Live updates from the GLOBAL socket; filter client-side
  function connectWS() {
    const base = (location.protocol === "https:" ? "wss://" : "ws://") + location.host;
    const ws = new WebSocket(base + "/ws/signals/");

    ws.onopen = () => { statusEl.textContent = "Live"; };
    ws.onmessage = (e) => {
      const sig = JSON.parse(e.data);
      renderCard(sig);
      if (!symbolUpper || String(sig.symbol||"").toUpperCase() === symbolUpper) {
        toast(sig.message);
      }
    };
    ws.onclose = () => { statusEl.textContent = "Reconnecting…"; setTimeout(connectWS, 1000); };
    ws.onerror  = () => { statusEl.textContent = "Error"; };
  }

  loadInitial();
  connectWS();
})();
</script>

</body>
</html>
