<!-- trading/templates/trading/stock_detail.html -->
{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'trading:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'trading:stock_list' %}">Stocks</a></li>
            <li class="breadcrumb-item active">{{ stock.symbol }}</li>
        </ol>
    </nav>

    <div class="row mb-4">
        <div class="col-md-8">
            <!-- Stock Header -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">
                    {{ stock.symbol }} - {{ stock.name }}
                </h2>
                <span class="badge bg-{% if stock.price_change >= 0 %}success{% else %}danger{% endif %} fs-6">
                    {% if stock.price_change >= 0 %}+{% endif %}{{ stock.price_change|floatformat:2 }}%
                </span>
            </div>

            <!-- Current Price -->
            <div class="card bg-light mb-4">
                <div class="card-body text-center py-4">
                    <h6 class="card-title text-muted">Current Price</h6>
                    <h1 class="display-4 fw-bold text-primary">₹{{ stock.current_price|floatformat:2|intcomma }}</h1>
                    <p class="text-muted mb-0">Last updated: {{ stock.last_updated|date:"M j, Y H:i" }}</p>
                </div>
            </div>

            <!-- Stock Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Stock Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="40%">Symbol:</th>
                                    <td>{{ stock.symbol }}</td>
                                </tr>
                                <tr>
                                    <th>Name:</th>
                                    <td>{{ stock.name }}</td>
                                </tr>
                                <tr>
                                    <th>Sector:</th>
                                    <td>{{ stock.sector|default:"N/A" }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="40%">Industry:</th>
                                    <td>{{ stock.industry|default:"N/A" }}</td>
                                </tr>
                                <tr>
                                    <th>Exchange:</th>
                                    <td>{{ stock.exchange|default:"N/A" }}</td>
                                </tr>
                                <tr>
                                    <th>Market Cap:</th>
                                    <td>
                                        {% if stock.market_cap %}
                                            ₹{{ stock.market_cap|intcomma }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'trading:trade_stock' stock.id %}" class="btn btn-primary btn-lg">
                            <i class="bi bi-arrow-left-right"></i> Trade This Stock
                        </a>
                        <button class="btn btn-outline-secondary" id="refreshPrice">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Price
                        </button>
                    </div>
                </div>
            </div>

            <!-- Price Statistics -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Price Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="border rounded p-2">
                                <small class="text-muted d-block">Day High</small>
                                <strong class="text-success">₹{{ stock.day_high|default:stock.current_price|floatformat:2 }}</strong>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="border rounded p-2">
                                <small class="text-muted d-block">Day Low</small>
                                <strong class="text-danger">₹{{ stock.day_low|default:stock.current_price|floatformat:2 }}</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <small class="text-muted d-block">52W High</small>
                                <strong class="text-success">₹{{ stock.year_high|default:stock.current_price|floatformat:2 }}</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <small class="text-muted d-block">52W Low</small>
                                <strong class="text-danger">₹{{ stock.year_low|default:stock.current_price|floatformat:2 }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Your Holdings (if any) -->
            {% if user_holdings %}
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Your Holdings</h5>
                </div>
                <div class="card-body">
                    {% for holding in user_holdings %}
                    <div class="border rounded p-3 mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong>Quantity:</strong>
                            <span>{{ holding.quantity }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong>Avg. Buy Price:</strong>
                            <span>₹{{ holding.average_buy_price|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>Current Value:</strong>
                            <span class="fw-bold">₹{{ holding.current_value|floatformat:2 }}</span>
                        </div>
                        <hr class="my-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>P/L:</strong>
                            <span class="{% if holding.profit_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                                ₹{{ holding.profit_loss|floatformat:2 }} ({{ holding.profit_loss_percentage|floatformat:2 }}%)
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Price History Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Price History (30 Days)</h5>
                </div>
                <div class="card-body">
                    <div id="priceChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Recent Transactions</h5>
                    <a href="{% url 'trading:transaction_list' %}?stock={{ stock.id }}" class="btn btn-sm btn-outline-primary">
                        View All
                    </a>
                </div>
                <div class="card-body p-0">
                    {% if recent_transactions %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th class="text-end">Quantity</th>
                                    <th class="text-end">Price</th>
                                    <th class="text-end">Total Value</th>
                                    {% if request.user.is_staff %}
                                      <th>User</th>
                                    {% endif %}
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in recent_transactions %}
                                <tr>
                                    <td>{{ transaction.timestamp|date:"M j, Y H:i" }}</td>
                                    <td>
                                        <span class="badge bg-{% if transaction.transaction_type == 'BUY' %}success{% else %}danger{% endif %}">
                                            {{ transaction.get_transaction_type_display }}
                                        </span>
                                    </td>
                                    <td class="text-end">{{ transaction.quantity }}</td>
                                    <td class="text-end">₹{{ transaction.price_per_share|floatformat:2 }}</td>
                                    <td class="text-end fw-bold">₹{{ transaction.total_cost|floatformat:2 }}</td>
                                    {% if request.user.is_staff %}
                                        <td>{{ transaction.user.username }}</td>
                                    {% endif %}
                                    <td>{{ transaction.notes|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-arrow-left-right" style="font-size: 3rem;"></i>
                        <p class="mt-2">No transactions for this stock yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Refresh price button
    document.getElementById('refreshPrice')?.addEventListener('click', function() {
        const btn = this;
        const originalHtml = btn.innerHTML;

        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Refreshing...';
        btn.disabled = true;

        // Simulate price refresh (replace with actual API call)
        setTimeout(function() {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
            alert('Price refreshed!'); // Replace with actual price update
            location.reload();
        }, 1500);
    });

    // Initialize price chart (mock data)
    am5.ready(function() {
        var root = am5.Root.new("priceChart");
        root.setThemes([am5themes_Animated.new(root)]);

        var chart = root.container.children.push(am5xy.XYChart.new(root, {
            panX: true,
            panY: true,
            wheelX: "panX",
            wheelY: "zoomX"
        }));

        var xAxis = chart.xAxes.push(am5xy.DateAxis.new(root, {
            baseInterval: { timeUnit: "day", count: 1 },
            renderer: am5xy.AxisRendererX.new(root, {})
        }));

        var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
            renderer: am5xy.AxisRendererY.new(root, {}),
            numberFormat: "'₹'#.##a"
        }));

        var series = chart.series.push(am5xy.LineSeries.new(root, {
            name: "Stock Price",
            xAxis: xAxis,
            yAxis: yAxis,
            valueYField: "value",
            valueXField: "date",
            tooltip: am5.Tooltip.new(root, {
                labelText: "₹{valueY}"
            })
        }));

        series.strokes.template.setAll({
            strokeWidth: 2
        });

        // Generate mock price data
        var priceData = [];
        var basePrice = {{ stock.current_price }};
        var today = new Date();

        for (var i = 30; i >= 0; i--) {
            var date = new Date(today);
            date.setDate(date.getDate() - i);

            var volatility = 0.02; // 2% daily volatility
            var change = (Math.random() - 0.5) * 2 * volatility;
            var price = basePrice * (1 + change);

            priceData.push({
                date: date.getTime(),
                value: price
            });
        }

        series.data.setAll(priceData);
        chart.set("cursor", am5xy.XYCursor.new(root, {}));
    });
});
</script>
{% endblock %}