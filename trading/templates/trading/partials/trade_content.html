{% load humanize %}
{% load django_bootstrap5 %}

<div class="container-fluid fade-me-in">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-arrow-left-right"></i>
                        {% if selected_stock %}
                            Trade {{ selected_stock.symbol }} - {{ selected_stock.name }}
                        {% else %}
                            Trade Stocks
                        {% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    {% if stocks_count == 0 %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            No stocks available in the system.
                            <!-- Use standard link here as it might be an admin page not converted to partials yet?
                                 Or if it is admin, keep as is. -->
                            <a href="{% url 'admin:trading_stock_add' %}" class="alert-link">Add stocks</a>
                        </div>
                    {% else %}
                        <form method="post" action="{% url 'trading:trade' %}"
                              hx-post="{% url 'trading:trade' %}"
                              hx-target="#main-content"
                              hx-push-url="true"
                              hx-indicator="#htmx-indicator">
                            {% csrf_token %}

                            {% if form.non_field_errors %}
                                <div class="alert alert-danger">
                                    {% for error in form.non_field_errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}

                            <!-- Portfolio Selection -->
                            {% if portfolios.count > 1 %}
                            <div class="mb-3">
                                <label class="form-label">Portfolio *</label>
                                {{ form.portfolio }}
                                {% if form.portfolio.errors %}
                                    <div class="text-danger">
                                        {% for error in form.portfolio.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            {% else %}
                                <input type="hidden" name="portfolio" value="{{ portfolios.first.id }}">
                            {% endif %}

                            <div class="row">
                                <!-- Left Column -->
                                <div class="col-md-6">
                                    <!-- Stock Selection -->
                                    <div class="mb-3">
                                        <label class="form-label">Stock *</label>
                                        {{ form.stock }}
                                        {% if form.stock.errors %}
                                            <div class="text-danger">
                                                {% for error in form.stock.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- Transaction Type -->
                                    <div class="mb-3">
                                        <label class="form-label">Transaction Type *</label>
                                        {{ form.transaction_type }}
                                        {% if form.transaction_type.errors %}
                                            <div class="text-danger">
                                                {% for error in form.transaction_type.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- Quantity -->
                                    <div class="mb-3">
                                        <label class="form-label">Quantity *</label>
                                        {{ form.quantity }}
                                        {% if form.quantity.errors %}
                                            <div class="text-danger">
                                                {% for error in form.quantity.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text" id="max-shares-info-page" style="display: none;">
                                            You own: <span id="owned-shares-page">0</span> shares
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Column -->
                                <div class="col-md-6">
                                    <!-- Price per Share -->
                                    <div class="mb-3">
                                        <label class="form-label">Price per Share (₹) *</label>
                                        {{ form.price_per_share }}
                                        {% if form.price_per_share.errors %}
                                            <div class="text-danger">
                                                {% for error in form.price_per_share.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">
                                            Current market price:
                                            <span id="current-price-page">
                                                {% if selected_stock %}
                                                    ₹{{ selected_stock.current_price|floatformat:2 }}
                                                {% else %}
                                                    Select a stock
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Notes -->
                                    <div class="mb-3">
                                        <label class="form-label">Notes</label>
                                        {{ form.notes }}
                                    </div>

                                    <!-- Summary -->
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Order Summary</h6>
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Quantity:</span>
                                                <span id="summary-quantity-page">0</span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Price per Share:</span>
                                                <span>₹<span id="summary-price-page">0.00</span></span>
                                            </div>
                                            <hr>
                                            <div class="d-flex justify-content-between fw-bold">
                                                <span>Total Amount:</span>
                                                <span id="summary-total-page">₹0.00</span>
                                            </div>
                                            <div class="d-flex justify-content-between mt-1">
                                                <span>Cash After Trade:</span>
                                                <span id="summary-cash-after-page">₹{{ portfolio.cash_balance|floatformat:2 }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-check-circle"></i> Execute Trade
                                </button>
                                <a href="{% url 'trading:stock_list' %}" class="btn btn-secondary"
                                   hx-get="{% url 'trading:stock_list' %}"
                                   hx-target="#main-content"
                                   hx-push-url="true">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </a>
                            </div>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Portfolio Summary -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-wallet2"></i> Portfolio Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Cash Balance:</strong>
                        <span class="float-end">₹{{ portfolio.cash_balance|floatformat:2|intcomma }}</span>
                    </div>
                    <div class="mb-3">
                        <strong>Total Value:</strong>
                        <span class="float-end">₹{{ portfolio.total_value|floatformat:2|intcomma }}</span>
                    </div>
                    <hr>
                    <h6>Your Holdings:</h6>
                    {% if portfolio.holdings.all %}
                        <div class="small" id="holdings-list">
                            {% for holding in portfolio.holdings.all %}
                                <div class="d-flex justify-content-between mb-1">
                                    <span>{{ holding.stock.symbol }}</span>
                                    <span>{{ holding.quantity }} shares</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No holdings yet</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Scoped execution for the partial
    (function() {
        // Need to target specific elements within this partial to avoid conflicts if multiple forms exist (unlikely but good practice)
        // Or just rely on ID uniqueness assuming this is the only main content.

        const stockSelect = document.querySelector('#id_stock');
        const quantityInput = document.querySelector('#id_quantity');
        const priceInput = document.querySelector('#id_price_per_share');
        const transactionTypeSelect = document.querySelector('#id_transaction_type');
        const portfolioSelect = document.querySelector('#id_portfolio');

        const summaryQuantity = document.querySelector('#summary-quantity-page');
        const summaryPrice = document.querySelector('#summary-price-page');
        const summaryTotal = document.querySelector('#summary-total-page');
        const summaryCashAfter = document.querySelector('#summary-cash-after-page');
        const currentPriceSpan = document.querySelector('#current-price-page');

        const maxSharesInfo = document.querySelector('#max-shares-info-page');
        const ownedShares = document.querySelector('#owned-shares-page');

        if (!stockSelect) return; // Guard against script running when elements not present

        // Function to get current price from selected stock
        function getCurrentPriceFromSelect() {
            if (stockSelect && stockSelect.options[stockSelect.selectedIndex]) {
                const option = stockSelect.options[stockSelect.selectedIndex];
                const priceText = option.text.match(/₹([\d.]+)/);
                if (priceText && priceText[1]) {
                    return parseFloat(priceText[1]);
                }
            }
            return 0;
        }

        function updateOrderSummary() {
            const stockId = stockSelect ? stockSelect.value : null;
            const quantity = parseInt(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const transactionType = transactionTypeSelect ? transactionTypeSelect.value : 'BUY';
            const portfolioId = portfolioSelect ? portfolioSelect.value : '{{ portfolios.first.id }}';

            // If no stock is selected, use the first one for calculation
            const effectiveStockId = stockId || (stockSelect && stockSelect.options.length > 0 ? stockSelect.options[0].value : null);

            if (!effectiveStockId || quantity <= 0 || price <= 0) {
                if (summaryQuantity) summaryQuantity.textContent = '0';
                if (summaryPrice) summaryPrice.textContent = '0.00';
                if (summaryTotal) summaryTotal.textContent = '₹0.00';
                if (summaryCashAfter) summaryCashAfter.textContent = '₹{{ portfolio.cash_balance|floatformat:2 }}';

                const currentPrice = getCurrentPriceFromSelect();
                if (currentPrice > 0 && currentPriceSpan) {
                    currentPriceSpan.textContent = "₹" + currentPrice.toFixed(2);
                }
                return;
            }

            // Get CSRF token from cookie
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');

            // Create JSON data
            const data = {
                stock_id: effectiveStockId,
                quantity: quantity,
                price: price,
                transaction_type: transactionType,
                portfolio_id: portfolioId
            };

            fetch("{% url 'trading:calculate_order' %}", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (summaryQuantity) summaryQuantity.textContent = data.quantity;
                    if (summaryPrice) summaryPrice.textContent = data.price.toFixed(2);
                    if (summaryTotal) summaryTotal.textContent = "₹" + data.total.toFixed(2);
                    if (summaryCashAfter) summaryCashAfter.textContent = "₹" + data.cash_after.toFixed(2);
                    if (currentPriceSpan) currentPriceSpan.textContent = "₹" + data.current_price.toFixed(2);

                    if (transactionType === 'SELL' && data.owned_shares !== undefined) {
                        if (maxSharesInfo) maxSharesInfo.style.display = 'block';
                        if (ownedShares) ownedShares.textContent = data.owned_shares;
                    } else {
                        if (maxSharesInfo) maxSharesInfo.style.display = 'none';
                    }
                }
            })
            .catch(err => console.error("Fetch error:", err));
        }

        // Initialize
        if (stockSelect && stockSelect.options.length > 0 && !stockSelect.value) {
            stockSelect.value = stockSelect.options[0].value;
        }
        if (quantityInput && !quantityInput.value) {
            quantityInput.value = 1;
        }
        if (priceInput && !priceInput.value) {
            const currentPrice = getCurrentPriceFromSelect();
            if (currentPrice > 0) {
                priceInput.value = currentPrice.toFixed(2);
            }
        }

        const inputsToWatch = [stockSelect, quantityInput, priceInput, transactionTypeSelect];
        if (portfolioSelect) inputsToWatch.push(portfolioSelect);

        inputsToWatch.forEach(input => {
            if (input) {
                input.addEventListener('change', updateOrderSummary);
                input.addEventListener('input', updateOrderSummary);
            }
        });

        updateOrderSummary();

        {% if selected_stock %}
        setTimeout(updateOrderSummary, 500);
        {% endif %}
    })();
</script>
